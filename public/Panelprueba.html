<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>REMEMBERSOON ¬∑ Panel del Cuidador</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ 
      --bg:#0b1220; 
      --surface:rgba(255,255,255,.08); 
      --text:#eaf0ff; 
      --muted:#b8c2d9; 
      --primary:#6ea8fe; 
      --primary-strong:#3b82f6; 
      --accent:#22d3ee; 
      --blue-btn-light:#60a5fa; 
      --blue-btn-dark:#2563eb; 
      --ok:#10b981; 
      --warn:#f59e0b; 
      --danger:#ef4444; 
      --shadow:0 10px 30px rgba(0,0,0,.35); 
      --radius:18px; 
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ 
      margin:0; 
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; 
      color:var(--text); 
      background: radial-gradient(1200px 800px at 20% 10%, #1b2a4a 0%, transparent 60%), 
                  radial-gradient(1000px 700px at 80% 90%, #0e856a33 0%, transparent 60%), 
                  linear-gradient(160deg, #0b1220 0%, #0e1324 100%); 
      display:grid; 
      place-items:center; 
      padding:24px; 
    }

    .panel{ 
      width:min(560px,100%); 
      backdrop-filter:saturate(135%) blur(8px); 
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04)); 
      border:1px solid rgba(255,255,255,.12); 
      border-radius:var(--radius); 
      box-shadow:var(--shadow); 
      padding:28px; 
      text-align:center; 
    }
    .logo{ 
      width:56px; 
      height:56px; 
      border-radius:14px; 
      display:grid; 
      place-items:center; 
      background:linear-gradient(135deg,var(--primary-strong),var(--accent)); 
      color:#061021; 
      font-weight:800; 
      margin:0 auto 10px; 
      box-shadow:0 8px 20px rgba(59,130,246,.35); 
    }
    h2{ 
      margin:0 0 16px; 
      font-size:clamp(22px,4vw,28px); 
      font-weight:800 
    }
    .sub{ 
      color:var(--muted); 
      margin:-8px 0 16px 
    }

    label{ 
      display:block; 
      text-align:left; 
      font-size:14px; 
      color:var(--muted); 
      margin-bottom:6px 
    }
    select{ 
      width:100%; 
      padding:12px; 
      border-radius:12px; 
      background:rgba(255,255,255,.06); 
      border:1px solid rgba(255,255,255,.14); 
      color:var(--text); 
      outline:none; 
    }

    .buttons{ 
      margin-top:18px; 
      display:grid; 
      gap:12px 
    }
    .row{ 
      display:grid; 
      grid-template-columns:1fr 1fr; 
      gap:12px 
    }
    @media (max-width:520px){ 
      .row{ 
        grid-template-columns:1fr 
      } 
    }

    .btn{ 
      appearance:none; 
      border:0; 
      border-radius:14px; 
      padding:12px 16px; 
      font-weight:700; 
      cursor:pointer; 
      transition:transform .08s ease, box-shadow .2s ease; 
    }
    .btn:active{ 
      transform:translateY(1px) 
    }
    .btn-primary{ 
      background:linear-gradient(180deg,var(--blue-btn-light),var(--blue-btn-dark)); 
      color:#f8fafc; 
      box-shadow:0 6px 18px rgba(37,99,235,.35); 
    }
    .btn-danger{ 
      background:linear-gradient(180deg,#fb7185,#ef4444); 
      color:#fff; 
      box-shadow:0 6px 18px rgba(239,68,68,.35); 
    }

    .footer{ 
      margin-top:8px; 
      color:var(--muted); 
      font-size:13px 
    }
  </style>
</head>
<body>
  <main class="panel">
    <div class="logo">RS</div>
    <h2>Panel del Cuidador: <span id="nombreCuidador"></span></h2>
    <p class="sub">Administra pacientes y recordatorios desde un solo lugar.</p>

    <div class="field">
      <label for="paciente">Paciente:</label>
      <select id="paciente">
        <!-- Opciones se cargar√°n con JS -->
      </select>
    </div>

    <div class="buttons">
      <div class="row">
        <button class="btn btn-primary" onclick="window.location.href='Agregarrecordatorioboton.html'">Agregar Recordatorio</button>
        <button class="btn btn-primary" onclick="window.location.href='listaderecordatorios.html'">Lista de Recordatorios</button>
      </div>
      <button class="btn btn-primary" onclick="window.location.href='agregarnuevopaciente.html'">Agregar Paciente</button>
      <button class="btn btn-danger" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>

    <p class="footer" id="helper"></p>
  </main>

  <!-- Toast visual -->
  <div id="toast" style="
    position: fixed;
    bottom: 30px;
    right: 30px;
    background-color: #22c55e;
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    font-size: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    display: none;
    z-index: 9999; ">
    ‚úÖ Recordatorio guardado con √©xito
  </div>

  <script>
    // Verificar que hay un usuario activo
    function verificarSesion() {
      const usuarioActivo = JSON.parse(localStorage.getItem('usuarioActivo'));
      
      if (!usuarioActivo || !usuarioActivo.id) {
        alert('Debes iniciar sesi√≥n primero');
        window.location.href = 'index.html';
        return false;
      }
      
      console.log('Usuario activo en panel:', usuarioActivo);
      return true;
    }

    // Cargar pacientes del cuidador
    async function cargarPacientes() {
      try {
        const usuarioActivo = JSON.parse(localStorage.getItem('usuarioActivo'));
        if (!usuarioActivo) {
          console.error("No hay usuario activo en sesi√≥n.");
          return;
        }

        const selectPaciente = document.getElementById("paciente");
        const response = await fetch(`/api/auth/pacientes/${usuarioActivo.id}`);
        const data = await response.json();

        if (data.success && data.pacientes.length > 0) {
          selectPaciente.innerHTML = data.pacientes.map(p => 
            `<option value="${p.id}">${p.nombre}</option>`
          ).join('');
        } else {
          selectPaciente.innerHTML = '<option value="">No hay pacientes registrados</option>';
        }
      } catch (error) {
        console.error("Error al cargar pacientes:", error);
      }
    }

    // Mostrar nombre del cuidador
    function mostrarNombreCuidador() {
      const usuarioActivo = JSON.parse(localStorage.getItem('usuarioActivo'));
      if (usuarioActivo && usuarioActivo.nombre) {
        document.getElementById("nombreCuidador").textContent = usuarioActivo.nombre;
      }
    }

    // Toast de notificaci√≥n
    const params = new URLSearchParams(window.location.search);
    if (params.get("guardado") === "ok") {
      const toast = document.getElementById("toast");
      toast.style.display = "block";
      setTimeout(() => {
        toast.style.display = "none";
        history.replaceState(null, "", window.location.pathname);
      }, 3000);
    }

    // Inicializar
    document.addEventListener("DOMContentLoaded", () => {
      if (!verificarSesion()) return; // VERIFICAR SESI√ìN PRIMERO
      
      mostrarNombreCuidador();
      cargarPacientes();
      document.getElementById('helper').textContent = 'Selecciona un paciente para trabajar con sus recordatorios.';
    });

    // Cerrar sesi√≥n
    function cerrarSesion() {
      if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
        localStorage.removeItem('usuarioActivo');
        localStorage.removeItem('nombreCuidador');
        window.location.href = 'index.html';
      }
    }

    // Verificar recordatorios pr√≥ximos - VERSI√ìN MEJORADA CREO LA V20
    async function verificarRecordatoriosProximos() {
      try {
        const usuarioActivo = JSON.parse(localStorage.getItem('usuarioActivo'));
        if (!usuarioActivo) {
          console.log('‚ùå No hay usuario activo para notificaciones');
          return;
        }

        console.log('üîç Revisando recordatorios pr√≥ximos...');
        
        const response = await fetch(`/api/recordatorios/cuidador/${usuarioActivo.id}`);
        const data = await response.json();

        if (data.success) {
          const ahora = new Date();
          console.log('üïê Hora actual:', ahora.toLocaleTimeString());
          
          const recordatoriosHoy = data.recordatorios.filter(rec => {
            const fechaRecordatorio = new Date(rec.fecha + 'T' + rec.hora);
            const diferencia = fechaRecordatorio - ahora;
            
            console.log(`üìÖ ${rec.titulo}: ${rec.fecha} ${rec.hora} - Diferencia: ${diferencia}ms`);
            
            // Notificar si falta entre 1 minuto y 1 hora
            return diferencia > 60000 && diferencia < 3600000; // 1 min a 1 hora
          });

          console.log(`‚úÖ ${recordatoriosHoy.length} recordatorios pr√≥ximos encontrados`);

          recordatoriosHoy.forEach(rec => {
            // Usar localStorage para evitar duplicados
            const notificadoKey = `notificado_${rec.id}`;
            if (!localStorage.getItem(notificadoKey)) {
              const fechaRecordatorio = new Date(rec.fecha + 'T' + rec.hora);
              const minutosRestantes = Math.round((fechaRecordatorio - ahora) / 60000);
              
              alert(`üîî RECORDATORIO PR√ìXIMO\n\nüìù ${rec.titulo}\n‚è∞ En ${minutosRestantes} minutos (${rec.hora})\nüë§ Paciente: ${rec.paciente_nombre}\nüö® Prioridad: ${rec.prioridad}`);
              
              // Marcar como notificado
              localStorage.setItem(notificadoKey, 'true');
            }
          });
        }
      } catch (error) {
        console.error('üí• Error en notificaciones:', error);
      }
    }

    // Verificar cada 1 minuto (para pruebas) en lugar de 5 minutos
    setInterval(verificarRecordatoriosProximos, 60000);
  </script>
</body>
</html>